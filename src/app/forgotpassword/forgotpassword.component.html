<div class="login-page d-flex flex-column align-items-center justify-content-center min-vh-100 bg-gradient">
  <div class="login-card bg-white shadow p-5 d-flex flex-column align-items-center" style="width: 100%; max-width: 400px;">
    <div class="text-center mb-4">
      <h2 class="fw-bold mb-2 main-title">Forgot Password</h2>
      <p class="text-muted small">Reset your password using OTP</p>
    </div>

    <form #forgotForm="ngForm" class="w-100">

      <!-- Email Field -->
      <div class="mb-4 position-relative">
        <label for="email" class="form-label text-muted small">Email</label>
        <div class="input-with-icon">
          <input
            id="email"
            type="email"
            name="email"
            class="form-control"
            [(ngModel)]="email"
            (ngModelChange)="validateEmail()"
            #emailField="ngModel"
            required
            pattern="^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$"
            [readonly]="otpSent"
          >
          <i class="bi bi-envelope icon-fixed"></i>
        </div>

        <!-- Live Email Validation -->
        <div *ngIf="email" class="mt-1 small"
             [ngClass]="isEmailValid ? 'text-success' : 'text-danger'">
          <i class="bi" [ngClass]="isEmailValid ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
          {{ isEmailValid ? 'Valid email address' : 'Invalid email format' }}
        </div>
      </div>

      <!-- Send OTP Button -->
      <button *ngIf="!otpSent"
        type="button"
        class="btn btn-primary w-100 fw-bold text-uppercase"
        (click)="sendOtp()"
        [disabled]="!isEmailValid">
        Send OTP
      </button>

      <!-- OTP Field -->
      <div *ngIf="otpSent && !otpVerified" class="mb-4 mt-3 position-relative">
        <label for="otp" class="form-label text-muted small">Enter OTP</label>
        <div class="input-with-icon">
          <input
            id="otp"
            type="text"
            name="otp"
            class="form-control"
            [(ngModel)]="otp"
            maxlength="6"
            required>
          <i class="bi bi-shield-lock icon-fixed"></i>
        </div>
        <button
          type="button"
          class="btn btn-success w-100 mt-3 fw-bold text-uppercase"
          (click)="verifyOtp()"
          [disabled]="!otp">
          Verify OTP
        </button>
      </div>

      <!-- New Password Field -->
      <div *ngIf="otpVerified" class="mb-4 position-relative">
        <label for="newPassword" class="form-label text-muted small">New Password</label>
        <div class="input-with-icon">
          <input
            id="newPassword"
            [type]="showPassword ? 'text' : 'password'"
            name="newPassword"
            class="form-control"
            [(ngModel)]="newPassword"
            (ngModelChange)="checkPasswordStrength()"
            #passwordField="ngModel"
            required>
          <i 
            class="bi toggle-eye icon-fixed"
            [ngClass]="showPassword ? 'bi-eye-slash' : 'bi-eye'"
            (click)="togglePassword()"></i>
        </div>

        <!-- Password Strength Rules -->
        <ul class="list-unstyled mt-2 small">
          <li [ngClass]="{'text-success': hasUppercase, 'text-danger': !hasUppercase}">
            <i class="bi" [ngClass]="hasUppercase ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
            Must contain uppercase letter
          </li>
          <li [ngClass]="{'text-success': hasLowercase, 'text-danger': !hasLowercase}">
            <i class="bi" [ngClass]="hasLowercase ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
            Must contain lowercase letter
          </li>
          <li [ngClass]="{'text-success': hasNumber, 'text-danger': !hasNumber}">
            <i class="bi" [ngClass]="hasNumber ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
            Must contain number
          </li>
          <li [ngClass]="{'text-success': hasSpecialChar, 'text-danger': !hasSpecialChar}">
            <i class="bi" [ngClass]="hasSpecialChar ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
            Must contain special character (@#$%^&+=!)
          </li>
          <li [ngClass]="{'text-success': isMinLength, 'text-danger': !isMinLength}">
            <i class="bi" [ngClass]="isMinLength ? 'bi-check-circle-fill' : 'bi-x-circle-fill'"></i>
            At least 6 characters long
          </li>
        </ul>

        <!-- Password Status -->
        <div *ngIf="newPassword" class="small"
             [ngClass]="isPasswordValid ? 'text-success fw-bold' : 'text-danger fw-bold'">
          {{ isPasswordValid ? '✅ Password is strong' : '❌ Password is not strong enough' }}
        </div>
      </div>

      <!-- Reset Password Button -->
      <button
        *ngIf="otpVerified"
        type="button"
        class="btn custom-btn btn-lg w-100 mt-2 fw-bold text-uppercase shadow-sm"
        (click)="resetPassword()"
        [disabled]="!isPasswordValid">
        Reset Password
      </button>

      <!-- Success/Error messages -->
      <p *ngIf="message" class="mt-3 text-success text-center">{{ message }}</p>
      <p *ngIf="errorMessage" class="mt-3 text-danger text-center">{{ errorMessage }}</p>

    </form>

    <!-- Back to Login -->
    <div class="mt-3 text-center">
      <a [routerLink]="['/userlogin']" class="register-link">Back to Login</a>
    </div>
  </div>
</div>
